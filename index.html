<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Snake Deluxe Â· Retro Arcade</title>
  <style>
    :root { color-scheme: dark; }

    /* --- Retro Arcade Theme --- */
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background:
        radial-gradient(circle at 20% 20%, #ff2bd622, transparent 40%),
        radial-gradient(circle at 80% 25%, #00ffd522, transparent 45%),
        radial-gradient(circle at 55% 90%, #ffd00022, transparent 50%),
        linear-gradient(180deg, #050814, #040510 60%, #02030b);
      color:#e6f0ff;
      touch-action: manipulation;
    }

    .wrap{ width:min(980px, 94vw); }
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin:14px 2px;
    }

    .card{
      border-radius:18px;
      padding:14px;
      border: 1px solid rgba(127, 199, 255, 0.25);
      background:
        radial-gradient(circle at 30% 10%, rgba(255,43,214,.12), transparent 40%),
        radial-gradient(circle at 80% 40%, rgba(0,255,213,.10), transparent 45%),
        linear-gradient(180deg, rgba(13,18,45,.78), rgba(6,8,20,.78));
      box-shadow:
        0 18px 60px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,255,255,.04) inset;
    }

    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(0,255,213,.35);
      background: rgba(2, 6, 18, .55);
      font-size:12.5px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      box-shadow: 0 0 18px rgba(0,255,213,.10);
    }
    .pill b{ font-size:13.5px; letter-spacing:.2px; }
    .kbd{
      display:inline-block; padding:2px 8px;
      border:1px solid rgba(255,43,214,.35);
      background: rgba(0,0,0,.25);
      border-radius:999px; font-size:12px;
      box-shadow: 0 0 12px rgba(255,43,214,.12);
    }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    button, select, label.toggle{
      border-radius:14px;
      border:1px solid rgba(127,199,255,.25);
      background: rgba(10,14,34,.75);
      color:#e6f0ff;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      letter-spacing:.2px;
      box-shadow:
        0 10px 22px rgba(0,0,0,.35),
        0 0 18px rgba(127,199,255,.10);
    }
    button:hover{ filter: brightness(1.08); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    select{ padding:10px 12px; }
    label.toggle{ display:flex; gap:8px; align-items:center; user-select:none; }
    label.toggle input{ accent-color:#00ffd5; }

    .game{
      display:grid;
      grid-template-columns: 1fr 300px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){
      .game{ grid-template-columns: 1fr; }
    }

    /* --- CRT Stage Frame --- */
    .stage{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      border: 1px solid rgba(255,43,214,.20);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.04) inset,
        0 0 40px rgba(255,43,214,.08),
        0 0 60px rgba(0,255,213,.06);
      background:
        radial-gradient(circle at 50% 120%, rgba(255,208,0,.10), transparent 45%),
        radial-gradient(circle at 0% 0%, rgba(0,255,213,.10), transparent 35%),
        radial-gradient(circle at 100% 0%, rgba(255,43,214,.12), transparent 35%),
        rgba(1,2,8,.75);
    }

    canvas{
      width:100%; height:auto;
      display:block;
      background: transparent;
      touch-action:none;
    }

    /* scanlines + vignette */
    .crt::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.05),
          rgba(255,255,255,.05) 1px,
          rgba(0,0,0,.00) 3px,
          rgba(0,0,0,.00) 6px
        );
      mix-blend-mode: overlay;
      opacity: .22;
      pointer-events:none;
    }
    .crt::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 45%, transparent 55%, rgba(0,0,0,.55) 100%);
      pointer-events:none;
      opacity:.55;
    }

    .overlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      background: rgba(0,0,0,.60);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .modal{
      width:min(560px, 92%);
      border-radius:18px;
      padding:16px;
      border:1px solid rgba(0,255,213,.28);
      background:
        radial-gradient(circle at 20% 0%, rgba(255,43,214,.18), transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(0,255,213,.12), transparent 45%),
        rgba(6, 10, 26, .92);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    .modal h2{ margin:0 0 8px; font-size:18px; letter-spacing:.2px; }
    .modal p{ margin:0 0 12px; opacity:.9; white-space:pre-line; line-height:1.35; }
    .modal .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .side .section{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(127,199,255,.18);
      background: rgba(5,8,22,.65);
      box-shadow: 0 0 22px rgba(127,199,255,.06);
    }
    .side h3{ margin:0 0 10px; font-size:13.5px; opacity:.95; }
    .stats{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
    .stat{
      border:1px solid rgba(0,255,213,.20);
      background: rgba(0,0,0,.22);
      border-radius:14px;
      padding:10px;
      box-shadow: 0 0 18px rgba(0,255,213,.06);
    }
    .stat .k{ font-size:12px; opacity:.7; }
    .stat .v{ font-size:22px; font-weight:900; margin-top:2px; text-shadow: 0 0 12px rgba(0,255,213,.15); }

    .hint{ margin-top:10px; font-size:12px; opacity:.8; line-height:1.35; }
    .list{ margin:0; padding-left:16px; font-size:13px; opacity:.95; }
    .list li{ margin:6px 0; }

    .pad{ margin-top:12px; display:none; justify-content:center; }
    @media (pointer: coarse){ .pad{ display:flex; } }
    .pad .padbox{
      display:grid;
      grid-template-columns: 62px 62px 62px;
      grid-template-rows: 62px 62px 62px;
      gap:10px;
      user-select:none;
      -webkit-user-select:none;
    }
    .pad button{ width:62px; height:62px; border-radius:16px; font-size:18px; }
    .pad .ghost{ visibility:hidden; }

    .toast{
      position:fixed; left:50%; top:16px; transform:translateX(-50%);
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,43,214,.35);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      box-shadow: 0 0 22px rgba(255,43,214,.12);
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(2px); }

    /* --- Optional: image-skin buttons (if assets exist) --- */
    .skin-btn{
      background: center/cover no-repeat;
      border: 0 !important;
      padding: 10px 14px;
      min-width: 110px;
      text-shadow: 0 0 10px rgba(0,0,0,.6);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="pill">
        <span>ğŸ•¹ï¸ <b>Snake Deluxe</b> Â· Retro Arcade</span>
        <span>ì´ë™: <span class="kbd">â†‘â†“â†â†’</span> / <span class="kbd">WASD</span> Â· ì¼ì‹œì •ì§€: <span class="kbd">Space</span></span>
      </div>

      <div class="btns">
        <select id="difficulty" title="ë‚œì´ë„">
          <option value="easy">EASY (ëŠë¦¼ Â· ë²½ í†µê³¼)</option>
          <option value="normal" selected>NORMAL (ë³´í†µ Â· ë²½ í†µê³¼)</option>
          <option value="hard">HARD (ë¹ ë¦„ Â· ë²½ ì¶©ëŒ)</option>
          <option value="insane">INSANE (ë§¤ìš°ë¹ ë¦„ Â· ë²½ ì¶©ëŒ)</option>
        </select>

        <label class="toggle" title="ì‚¬ìš´ë“œ">
          <input id="sound" type="checkbox" checked />
          ğŸ”Š ì‚¬ìš´ë“œ
        </label>

        <button id="start">ì‹œì‘</button>
        <button id="pause">ì¼ì‹œì •ì§€</button>
        <button id="restart">ì¬ì‹œì‘</button>
      </div>
    </div>

    <div class="game">
      <div class="card" style="padding:12px;">
        <div class="stage crt">
          <canvas id="c" width="640" height="640" aria-label="Snake ê²Œì„ í™”ë©´"></canvas>

          <div class="overlay" id="overlay">
            <div class="modal">
              <h2 id="ovTitle">READY</h2>
              <p id="ovText">START ë²„íŠ¼ ë˜ëŠ” Enter!</p>
              <div class="grid">
                <button id="ovStart">ë°”ë¡œ ì‹œì‘</button>
                <button id="ovClose" style="background:rgba(0,0,0,.25);">ë‹«ê¸°</button>
              </div>
              <div class="hint" style="margin-top:10px;">
                ëª¨ë°”ì¼ì€ <b>ìŠ¤ì™€ì´í”„</b> ë˜ëŠ” ì•„ë˜ D-Padë¡œ ì¡°ì‘ ê°€ëŠ¥.
              </div>
            </div>
          </div>
        </div>

        <div class="pad">
          <div class="padbox">
            <div class="ghost"></div>
            <button data-dir="up">â–²</button>
            <div class="ghost"></div>
            <button data-dir="left">â—€</button>
            <button data-dir="down">â–¼</button>
            <button data-dir="right">â–¶</button>
            <div class="ghost"></div>
            <button id="padPause">â¸</button>
            <div class="ghost"></div>
          </div>
        </div>
      </div>

      <div class="card side">
        <div class="section">
          <h3>í˜„ì¬ ê¸°ë¡</h3>
          <div class="stats">
            <div class="stat"><div class="k">ì ìˆ˜</div><div class="v" id="score">0</div></div>
            <div class="stat"><div class="k">ê¸¸ì´</div><div class="v" id="len">3</div></div>
            <div class="stat"><div class="k">ì†ë„</div><div class="v" id="spd">7</div></div>
            <div class="stat"><div class="k">ìƒíƒœ</div><div class="v" id="state">ëŒ€ê¸°</div></div>
          </div>
          <div class="hint">
            â€¢ ë¨¹ì´(ì´ˆë¡)ì„ ë¨¹ìœ¼ë©´ ì ìˆ˜+1, ê¸¸ì´ ì¦ê°€<br/>
            â€¢ ì—°ì†ìœ¼ë¡œ ë¨¹ìœ¼ë©´ ì†ë„ ì¡°ê¸ˆ ì¦ê°€
          </div>
        </div>

        <div class="section" style="margin-top:12px;">
          <h3>ë­í‚¹(ë¡œì»¬ ì €ì¥)</h3>
          <ol class="list" id="board"></ol>
          <div class="hint">
            ê¸°ë¡ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë¼ìš”.<br/>
            ì´ˆê¸°í™”í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼.
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="clearRank" style="background:rgba(0,0,0,.25);">ë­í‚¹ ì´ˆê¸°í™”</button>
            <button id="help" style="background:rgba(0,0,0,.25);">ë„ì›€ë§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">TOAST</div>

<script>
(() => {
  const cv = document.getElementById('c');
  const ctx = cv.getContext('2d');

  const scoreEl = document.getElementById('score');
  const lenEl   = document.getElementById('len');
  const spdEl   = document.getElementById('spd');
  const stateEl = document.getElementById('state');
  const boardEl = document.getElementById('board');

  const startBtn = document.getElementById('start');
  const pauseBtn = document.getElementById('pause');
  const restartBtn = document.getElementById('restart');
  const diffSel = document.getElementById('difficulty');
  const soundChk = document.getElementById('sound');

  const overlay = document.getElementById('overlay');
  const ovTitle = document.getElementById('ovTitle');
  const ovText  = document.getElementById('ovText');
  const ovStart = document.getElementById('ovStart');
  const ovClose = document.getElementById('ovClose');

  const toast = document.getElementById('toast');

  const RANK_KEY = 'snake_deluxe_rank_arcade_v1';
  const CFG_KEY  = 'snake_deluxe_cfg_arcade_v1';

  const N = 28;
  const cell = cv.width / N;

  let running = false;
  let paused  = false;
  let gameOver = false;

  let snake = [];
  let dir = {x:1, y:0};
  let nextDir = {x:1, y:0};
  let food = null;

  let score = 0;
  let speed = 7;
  let tick = 0;
  let lastEatAt = 0;

  let wallMode = 'wrap';

  // --- Optional Firefly assets (auto-skin if present)
  const ASSET = {
    bg:   "assets/bg_stage.png",
    btnStart: "assets/btn_start.png",
    btnPause: "assets/btn_pause.png",
    btnRestart:"assets/btn_restart.png",
    btnClose: "assets/btn_close.png",
    sprHead: "assets/spr_head.png",
    sprBody: "assets/spr_body.png",
    sprFood: "assets/spr_food.png",
  };
  const img = {};
  function loadImage(key, src){
    return new Promise((resolve) => {
      const im = new Image();
      im.onload = () => resolve({key, ok:true, im});
      im.onerror = () => resolve({key, ok:false, im:null});
      im.src = src;
    });
  }
  async function loadAssets(){
    const keys = Object.keys(ASSET);
    const results = await Promise.all(keys.map(k=>loadImage(k, ASSET[k])));
    results.forEach(r => { img[r.key] = r.ok ? r.im : null; });
    applySkinsIfReady();
  }
  function applySkinsIfReady(){
    // If button images exist, skin them
    if(img.btnStart){
      startBtn.classList.add('skin-btn');
      startBtn.style.backgroundImage = `url("${ASSET.btnStart}")`;
      startBtn.textContent = "";
      startBtn.setAttribute("aria-label","ì‹œì‘");
      startBtn.title = "ì‹œì‘";
      startBtn.style.minWidth = "130px";
      startBtn.style.height = "44px";
    }
    if(img.btnPause){
      pauseBtn.classList.add('skin-btn');
      pauseBtn.style.backgroundImage = `url("${ASSET.btnPause}")`;
      pauseBtn.textContent = "";
      pauseBtn.setAttribute("aria-label","ì¼ì‹œì •ì§€");
      pauseBtn.title = "ì¼ì‹œì •ì§€";
      pauseBtn.style.minWidth = "130px";
      pauseBtn.style.height = "44px";
    }
    if(img.btnRestart){
      restartBtn.classList.add('skin-btn');
      restartBtn.style.backgroundImage = `url("${ASSET.btnRestart}")`;
      restartBtn.textContent = "";
      restartBtn.setAttribute("aria-label","ì¬ì‹œì‘");
      restartBtn.title = "ì¬ì‹œì‘";
      restartBtn.style.minWidth = "130px";
      restartBtn.style.height = "44px";
    }
    if(img.btnClose){
      ovClose.classList.add('skin-btn');
      ovClose.style.backgroundImage = `url("${ASSET.btnClose}")`;
      ovClose.textContent = "";
      ovClose.setAttribute("aria-label","ë‹«ê¸°");
      ovClose.title = "ë‹«ê¸°";
      ovClose.style.height = "44px";
    }
  }

  // --- tiny sound (WebAudio beeps)
  let audio = null;
  function ensureAudio() {
    if (!audio) audio = new (window.AudioContext || window.webkitAudioContext)();
  }
  function beep(freq=440, dur=0.06, type='square', gain=0.06) {
    if (!soundChk.checked) return;
    ensureAudio();
    const t0 = audio.currentTime;
    const o = audio.createOscillator();
    const g = audio.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(gain, t0);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g).connect(audio.destination);
    o.start(t0);
    o.stop(t0 + dur);
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 900);
  }

  function loadCfg(){
    try{
      const cfg = JSON.parse(localStorage.getItem(CFG_KEY) || '{}');
      if (cfg.difficulty) diffSel.value = cfg.difficulty;
      if (typeof cfg.sound === 'boolean') soundChk.checked = cfg.sound;
    }catch{}
  }
  function saveCfg(){
    localStorage.setItem(CFG_KEY, JSON.stringify({
      difficulty: diffSel.value,
      sound: soundChk.checked
    }));
  }

  function loadRank(){
    try { return JSON.parse(localStorage.getItem(RANK_KEY) || '[]'); }
    catch { return []; }
  }
  function saveRank(list){
    localStorage.setItem(RANK_KEY, JSON.stringify(list));
  }
  function renderRank(){
    const list = loadRank();
    boardEl.innerHTML = '';
    if (!list.length){
      const li = document.createElement('li');
      li.textContent = 'ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”!';
      boardEl.appendChild(li);
      return;
    }
    list.forEach((r)=>{
      const li = document.createElement('li');
      li.textContent = `${r.score}ì  Â· ê¸¸ì´ ${r.len} Â· ${r.diff} Â· ${new Date(r.at).toLocaleString()}`;
      boardEl.appendChild(li);
    });
  }

  function applyDifficulty(){
    const d = diffSel.value;
    if (d === 'easy'){ speed = 6; wallMode = 'wrap'; }
    if (d === 'normal'){ speed = 7; wallMode = 'wrap'; }
    if (d === 'hard'){ speed = 10; wallMode = 'solid'; }
    if (d === 'insane'){ speed = 13; wallMode = 'solid'; }
  }

  function rndCell(){
    return { x: Math.floor(Math.random()*N), y: Math.floor(Math.random()*N) };
  }
  function eq(a,b){ return a.x===b.x && a.y===b.y; }

  function spawnFood(){
    while(true){
      const f = rndCell();
      if (!snake.some(s=>eq(s,f))) return f;
    }
  }

  function resetGame(keepOverlay=false){
    applyDifficulty();
    score = 0;
    snake = [{x:14,y:14},{x:13,y:14},{x:12,y:14}];
    dir = {x:1,y:0};
    nextDir = {x:1,y:0};
    food = spawnFood();
    tick = 0;
    paused = false;
    running = false;
    gameOver = false;
    lastEatAt = 0;

    updateUI();
    if(!keepOverlay) hideOverlay();
    draw();
  }

  function updateUI(){
    scoreEl.textContent = score;
    lenEl.textContent = snake.length;
    spdEl.textContent = speed;
    stateEl.textContent = gameOver ? 'ì¢…ë£Œ' : (paused ? 'ì¼ì‹œì •ì§€' : (running ? 'ì§„í–‰' : 'ëŒ€ê¸°'));
    pauseBtn.textContent = paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
  }

  function showOverlay(title, text){
    ovTitle.textContent = title;
    ovText.textContent = text;
    overlay.classList.add('show');
  }
  function hideOverlay(){
    overlay.classList.remove('show');
  }

  function setDir(x,y){
    if (gameOver) return;
    if (dir.x === -x && dir.y === -y) return;
    nextDir = {x,y};
  }

  function start(){
    if (gameOver) resetGame(true);
    if (running) return;
    running = true;
    paused = false;
    hideOverlay();
    updateUI();
    showToast('INSERT COIN â†’ START!');
    beep(660,0.06,'square',0.06);
  }

  function togglePause(){
    if (!running && !gameOver) return;
    if (gameOver) return;
    paused = !paused;
    updateUI();
    showToast(paused ? 'PAUSED' : 'RESUME');
    beep(paused ? 220 : 440, 0.06, 'square', 0.06);
  }

  function end(){
    running = false;
    gameOver = true;
    updateUI();
    beep(160,0.10,'sawtooth',0.07);
    setTimeout(()=>beep(120,0.12,'sawtooth',0.06), 90);

    const list = loadRank();
    list.push({ score, len: snake.length, diff: diffSel.options[diffSel.selectedIndex].textContent.split(' ')[0], at: Date.now() });
    list.sort((a,b)=>b.score-a.score);
    saveRank(list.slice(0,5));
    renderRank();

    showOverlay('GAME OVER', `SCORE ${score}  Â·  LENGTH ${snake.length}\n"ë°”ë¡œ ì‹œì‘" ë˜ëŠ” R í‚¤ë¡œ ì¬ë„ì „!`);
  }

  function step(){
    if (!running || paused || gameOver) return;

    tick++;
    const framesPerMove = Math.max(2, Math.floor(60 / speed));
    if (tick % framesPerMove !== 0) return;

    dir = nextDir;
    const head = snake[0];
    let nx = head.x + dir.x;
    let ny = head.y + dir.y;

    if (wallMode === 'wrap'){
      nx = (nx + N) % N;
      ny = (ny + N) % N;
    } else {
      if (nx < 0 || ny < 0 || nx >= N || ny >= N){
        end();
        return;
      }
    }

    const newHead = {x:nx, y:ny};

    if (snake.some((s,i)=> i>0 && eq(s,newHead))){
      end();
      return;
    }

    snake.unshift(newHead);

    if (eq(newHead, food)){
      score++;
      const now = performance.now();
      if (now - lastEatAt < 1800) speed = Math.min(16, speed + 1);
      lastEatAt = now;
      food = spawnFood();
      beep(880,0.05,'square',0.05);
      showToast(`+1  SCORE ${score}`);
    } else {
      snake.pop();
    }

    updateUI();
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);

    // background image if exists
    if (img.bg){
      // tile
      const pat = ctx.createPattern(img.bg, 'repeat');
      ctx.save();
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = pat;
      ctx.fillRect(0,0,cv.width,cv.height);
      ctx.restore();
    } else {
      // fallback grid glow
      ctx.save();
      ctx.globalAlpha = 0.22;
      ctx.strokeStyle = '#1b2b66';
      for(let i=0;i<=N;i++){
        ctx.beginPath(); ctx.moveTo(i*cell,0); ctx.lineTo(i*cell,cv.height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,i*cell); ctx.lineTo(cv.width,i*cell); ctx.stroke();
      }
      ctx.restore();
    }

    // food
    if (img.sprFood){
      const x = food.x*cell, y = food.y*cell;
      ctx.drawImage(img.sprFood, x+4, y+4, cell-8, cell-8);
    } else {
      ctx.fillStyle = '#00ffd5';
      ctx.beginPath();
      ctx.arc((food.x+0.5)*cell, (food.y+0.5)*cell, cell*0.28, 0, Math.PI*2);
      ctx.fill();
      ctx.shadowColor = '#00ffd5';
      ctx.shadowBlur = 10;
      ctx.fill();
      ctx.shadowBlur = 0;
    }

    // snake
    for (let i=snake.length-1; i>=0; i--){
      const s = snake[i];
      const x = s.x*cell, y = s.y*cell;

      if (i===0 && img.sprHead){
        ctx.drawImage(img.sprHead, x+3, y+3, cell-6, cell-6);
      } else if (i>0 && img.sprBody){
        ctx.drawImage(img.sprBody, x+3, y+3, cell-6, cell-6);
      } else {
        // fallback neon blocks
        ctx.save();
        ctx.fillStyle = (i===0) ? '#ff2bd6' : '#7fc7ff';
        ctx.shadowColor = (i===0) ? '#ff2bd6' : '#7fc7ff';
        ctx.shadowBlur = 10;
        ctx.fillRect(x+2, y+2, cell-4, cell-4);
        ctx.restore();
      }
    }

    // border
    ctx.strokeStyle = 'rgba(255,43,214,.25)';
    ctx.strokeRect(0.5,0.5,cv.width-1,cv.height-1);

    // wall mode badge
    ctx.fillStyle = 'rgba(0,0,0,.35)';
    ctx.fillRect(10,10, 210, 30);
    ctx.fillStyle = '#e6f0ff';
    ctx.font = 'bold 13px ui-monospace, monospace';
    ctx.fillText(`WALL: ${wallMode==='wrap'?'WARP':'SOLID'}`, 18, 30);
  }

  function loop(){
    step();
    draw();
    requestAnimationFrame(loop);
  }

  // controls
  startBtn.addEventListener('click', start);
  pauseBtn.addEventListener('click', togglePause);
  restartBtn.addEventListener('click', () => { resetGame(true); start(); });

  diffSel.addEventListener('change', () => { saveCfg(); showToast('DIFFICULTY SAVED'); });
  soundChk.addEventListener('change', () => { saveCfg(); showToast(soundChk.checked ? 'SOUND ON' : 'SOUND OFF'); if(soundChk.checked) beep(440,0.06,'square',0.05); });

  document.getElementById('clearRank').addEventListener('click', () => {
    localStorage.removeItem(RANK_KEY);
    renderRank();
    showToast('RANK RESET');
  });
  document.getElementById('help').addEventListener('click', () => {
    showOverlay('HOW TO PLAY',
      `â€¢ EAT the neon food to score
â€¢ EASY/NORMAL: WARP walls
â€¢ HARD/INSANE: SOLID walls = GAME OVER
â€¢ Mobile: swipe or D-Pad
â€¢ Space: Pause/Resume`
    );
  });

  ovStart.addEventListener('click', () => { resetGame(true); start(); });
  ovClose.addEventListener('click', () => overlay.classList.remove('show'));

  addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if (k === 'arrowup' || k === 'w') setDir(0,-1);
    if (k === 'arrowdown' || k === 's') setDir(0,1);
    if (k === 'arrowleft' || k === 'a') setDir(-1,0);
    if (k === 'arrowright' || k === 'd') setDir(1,0);
    if (k === ' ') togglePause();
    if (k === 'enter') start();
    if (k === 'r') { resetGame(true); start(); }
  });

  // mobile D-pad
  document.querySelectorAll('.pad button[data-dir]').forEach(btn=>{
    const d = btn.dataset.dir;
    const map = {up:[0,-1], down:[0,1], left:[-1,0], right:[1,0]};
    const [x,y] = map[d];
    const fire = (e)=>{ e.preventDefault(); setDir(x,y); if(!running && !gameOver) start(); };
    btn.addEventListener('click', fire);
    btn.addEventListener('touchstart', fire, {passive:false});
  });
  document.getElementById('padPause').addEventListener('click', togglePause);
  document.getElementById('padPause').addEventListener('touchstart', (e)=>{e.preventDefault(); togglePause();},{passive:false});

  // swipe control
  let sx=0, sy=0;
  cv.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    sx=t.clientX; sy=t.clientY;
    if(!running && !gameOver) start();
  }, {passive:false});

  cv.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    const dx = t.clientX - sx;
    const dy = t.clientY - sy;
    const adx = Math.abs(dx), ady = Math.abs(dy);
    if (Math.max(adx, ady) < 24) return;
    if (adx > ady) setDir(dx > 0 ? 1 : -1, 0);
    else setDir(0, dy > 0 ? 1 : -1);
    sx=t.clientX; sy=t.clientY;
  }, {passive:false});

  // init
  loadCfg();
  renderRank();
  resetGame(true);
  showOverlay('READY', 'START ë²„íŠ¼ ë˜ëŠ” Enter!\n(ëª¨ë°”ì¼: ìŠ¤ì™€ì´í”„ ê°€ëŠ¥)');
  loadAssets();       // <-- Firefly PNGê°€ ìƒê¸°ë©´ ìë™ ì ìš©
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
